<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết Sản phẩm - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #6b7280; border-bottom: 2px solid transparent; }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Toggle Switch CSS */
        .toggle-checkbox:checked { right: 0; border-color: #2563eb; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563eb; }
        .toggle-checkbox { right: 0; z-index: 1; border-color: #e5e7eb; transition: all 0.3s; }
        .toggle-label { width: 3rem; height: 1.5rem; background-color: #d1d5db; transition: background-color 0.3s; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="products.html" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-xl font-bold text-gray-800" id="page-title">Đang tải...</h1>
                <p class="text-xs text-gray-500" id="page-id">ID: ...</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="saveAllChanges()" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 shadow flex items-center gap-2">
                <i class="fa-solid fa-floppy-disk"></i> Lưu Chung
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 mt-6">
        <div class="flex border-b border-gray-300">
            <button onclick="switchTab('general')" id="tab-btn-general" class="tab-active px-6 py-3 text-sm font-medium transition-colors">Thông tin chung</button>
            <button onclick="switchTab('specs')" id="tab-btn-specs" class="tab-inactive px-6 py-3 text-sm font-medium transition-colors">Thông số kỹ thuật</button>
            <button onclick="switchTab('variants')" id="tab-btn-variants" class="tab-inactive px-6 py-3 text-sm font-medium transition-colors"><i class="fa-solid fa-layer-group mr-2"></i>Biến thể (Nâng cao)</button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-6">
        <div id="content-general" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Thông tin sản phẩm</h3>
                    <div class="grid gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Tên sản phẩm</label>
                            <input type="text" id="p-title" class="w-full px-3 py-2 border rounded font-medium">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Giá niêm yết (Gốc)</label>
                                <input type="number" id="p-price" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Danh mục</label>
                                <select id="p-category" class="w-full px-3 py-2 border rounded bg-white">
                                    <option value="">-- Chọn --</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Hãng sản xuất</label>
                                <select id="p-brand" class="w-full px-3 py-2 border rounded bg-white" disabled>
                                    <option value="">-- Chọn hãng --</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded border border-gray-200 flex justify-between items-center">
                            <div>
                                <label class="text-sm font-bold text-gray-800 block">Trạng thái kinh doanh</label>
                                <p class="text-xs text-gray-500">Tắt/Bật hiển thị sản phẩm với khách hàng.</p>
                            </div>
                            <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="is_active" id="p-is-active" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="p-is-active" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-3 rounded border border-blue-200">
                            <label class="text-xs font-bold text-blue-700 uppercase flex justify-between">
                                Tổng Tồn Kho
                                <span id="stock-source-badge" class="hidden text-[10px] bg-white text-blue-600 px-2 py-0.5 rounded-full font-bold border border-blue-200">Tự động tính từ biến thể</span>
                            </label>
                            <input type="number" id="p-stock" class="w-full px-3 py-2 border rounded mt-1 bg-white font-bold text-gray-800">
                            <p id="stock-hint" class="text-[10px] text-gray-500 mt-1 italic hidden">Số lượng này được cộng dồn từ các biến thể và không thể sửa thủ công.</p>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Mô tả</label>
                            <textarea id="p-desc" rows="4" class="w-full px-3 py-2 border rounded text-sm"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Ảnh đại diện (Thumbnail)</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 relative group">
                        <img id="preview-main-img" src="https://placehold.co/150" class="h-40 mx-auto object-contain">
                        <input type="file" id="main-image-upload" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*">
                        <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white font-bold text-sm rounded-lg pointer-events-none">
                            <i class="fa-solid fa-pen mr-2"></i> Đổi ảnh
                        </div>
                    </div>
                    <input type="hidden" id="p-image">
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-gray-500 uppercase block">Bộ sưu tập chung</label>
                        <label class="cursor-pointer text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 font-bold transition">
                            <i class="fa-solid fa-plus"></i> Thêm ảnh
                            <input type="file" multiple class="hidden" id="shared-gallery-upload" accept="image/*">
                        </label>
                    </div>
                    <div id="shared-gallery-container" class="grid grid-cols-4 gap-2"></div>
                </div>
            </div>
        </div>

        <div id="content-specs" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div id="specs-container"></div>
            </div>
        </div>

        <div id="content-variants" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 mb-2 uppercase">1. Cấu hình thuộc tính</h4>
                    <p class="text-xs text-gray-600 mb-3">Chọn thuộc tính phân loại. Hệ thống sẽ tự động nhóm theo <strong>Màu sắc</strong>.</p>
                    <div id="variant-config-checkboxes" class="flex flex-wrap gap-4"></div>
                </div>

                <div class="flex justify-between items-center">
                    <h4 class="text-sm font-bold text-gray-800 uppercase">2. Chi tiết biến thể</h4>
                    <div class="flex gap-2">
                        <button onclick="addVariantGroup()" class="bg-white text-blue-600 border border-blue-200 px-3 py-1.5 rounded text-sm font-bold hover:bg-blue-50">
                            <i class="fa-solid fa-plus-circle"></i> Thêm Nhóm Màu
                        </button>
                        <button onclick="saveVariants()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm font-bold shadow hover:bg-blue-700">
                            <i class="fa-solid fa-save"></i> Lưu Thay Đổi
                        </button>
                    </div>
                </div>

                <div id="variant-groups-container" class="space-y-6"></div>
            </div>
        </div>
    </main>

    <div id="toast-root"></div>

    <script type="module">
        import { renderAdminLayout } from '../assets/js/admin.js';
        import { api } from '../assets/js/api.js';
        import { getQueryParam } from '../assets/js/utils/url.js';
        import { showToast } from '../assets/js/ui/toast.js';

        const productId = getQueryParam('id');
        let currentSpecsData = {};
        let allCategories = [];
        let activeVariantKeys = []; 
        let allVariantsData = []; 
        let currentSharedGallery = [];

        async function initPage() {
            await renderAdminLayout('products');
            if (!productId) { showToast('Không tìm thấy ID sản phẩm', 'error'); return; }

            const sharedInput = document.getElementById('shared-gallery-upload');
            if (sharedInput) {
                sharedInput.addEventListener('change', async (e) => {
                    const files = e.target.files;
                    if(!files.length) return;
                    showToast('Đang tải ảnh lên...', 'info');
                    for(let i=0; i<files.length; i++) {
                        const fd = new FormData();
                        fd.append('image', files[i]);
                        try { await api.uploadProductImage(productId, fd); } catch(err){}
                    }
                    showToast('Hoàn tất tải ảnh', 'success');
                    const p = await api.getProduct(productId);
                    currentSharedGallery = p.shared_gallery || [];
                    renderSharedGallery(currentSharedGallery);
                    e.target.value = '';
                });
            }
            const mainInput = document.getElementById('main-image-upload');
            if (mainInput) {
                mainInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const fd = new FormData();
                    fd.append('image', file);
                    try {
                        const res = await api.uploadProductImage(productId, fd);
                        document.getElementById('p-image').value = res.url;
                        document.getElementById('preview-main-img').src = '../' + res.url;
                        showToast('Đã cập nhật ảnh đại diện', 'success');
                    } catch (err) { showToast('Lỗi upload: ' + err.message, 'error'); }
                    e.target.value = '';
                });
            }

            try {
                const p = await api.getProduct(productId);

                document.getElementById('page-title').textContent = p.title;
                document.getElementById('page-id').textContent = 'ID: ' + p.id;
                document.getElementById('p-title').value = p.title || '';
                document.getElementById('p-price').value = p.price || 0;
                document.getElementById('p-desc').value = p.description || '';
                document.getElementById('p-image').value = p.image || '';
                document.getElementById('p-stock').value = p.stock_quantity || 0;
                document.getElementById('p-is-active').checked = (p.is_active != 0);

                const imgUrl = p.image ? (p.image.startsWith('http') ? p.image : `../${p.image}`) : 'https://placehold.co/150';
                document.getElementById('preview-main-img').src = imgUrl;

                // KHỞI TẠO CATEGORY VÀ BRAND
                await loadCategoriesAndInit(p.category, p.brand);
                
                currentSharedGallery = p.shared_gallery || [];
                renderSharedGallery(currentSharedGallery);

                try { currentSpecsData = JSON.parse(p.specs || '{}'); } catch (e) {}
                const catObj = allCategories.find(c => c.slug === p.category);
                let tmpl = [];
                try { tmpl = JSON.parse(catObj?.specs_template || '[]'); } catch (e) {}
                renderSpecsForm(tmpl, currentSpecsData);

                initVariantConfig(tmpl);
                await loadVariants();
            } catch (e) {
                console.error(e);
                showToast('Lỗi tải dữ liệu sản phẩm', 'error');
            }
        }

        window.switchTab = (tab) => {
            ['general', 'specs', 'variants'].forEach(t => {
                const content = document.getElementById(`content-${t}`);
                const btn = document.getElementById(`tab-btn-${t}`);
                if (content) content.classList.toggle('hidden', t !== tab);
                if (btn) btn.className = t === tab ? 'tab-active px-6 py-3 text-sm font-medium transition-colors' : 'tab-inactive px-6 py-3 text-sm font-medium transition-colors hover:bg-gray-50';
            });
        };

        function renderSharedGallery(images) {
            const container = document.getElementById('shared-gallery-container');
            const mainImageUrl = document.getElementById('p-image').value;
            const filteredImages = (images || []).filter(url => url !== mainImageUrl);
            if(filteredImages.length === 0) { container.innerHTML = '<span class="text-xs text-gray-400 italic col-span-4 text-center py-2">Chưa có ảnh chung.</span>'; return; }
            container.innerHTML = filteredImages.map(url => `
                <div class="relative aspect-square border rounded overflow-hidden group/img bg-white">
                    <img src="../${url}" class="w-full h-full object-cover">
                    <button onclick="removeSharedImage(this, '${url}')" class="absolute inset-0 bg-black/50 hidden group-hover/img:flex items-center justify-center text-white transition"><i class="fa-solid fa-trash"></i></button>
                </div>`).join('');
        }
        window.removeSharedImage = async (btn, url) => {
            if(!confirm('Xóa ảnh này?')) return;
            try { await api.request('/products/delete-image', { method: 'POST', auth: true, body: { image_url: url } }); currentSharedGallery = currentSharedGallery.filter(img => img !== url); renderSharedGallery(currentSharedGallery); showToast('Đã xóa ảnh', 'success'); } catch(e) { showToast(e.message, 'error'); }
        };

        window.initVariantConfig = (template) => {
            const container = document.getElementById('variant-config-checkboxes');
            container.innerHTML = `<label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-gray-200"><input type="checkbox" value="color" data-label="Màu sắc" class="variant-key-cb text-blue-600 rounded" checked disabled><span class="text-sm font-medium">Màu sắc (Bắt buộc)</span></label>`;
            if (template) {
                template.forEach(g => { if (g.fields) g.fields.forEach(f => { if (f.k === 'color') return; container.innerHTML += `<label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-gray-200 hover:border-blue-300"><input type="checkbox" value="${f.k}" data-label="${f.l}" class="variant-key-cb text-blue-600 rounded"><span class="text-sm font-medium">${f.l}</span></label>`; }); });
            }
            document.querySelectorAll('.variant-key-cb').forEach(cb => cb.addEventListener('change', () => { updateActiveKeys(); renderVariantsByGroup(); }));
            updateActiveKeys();
        };
        function updateActiveKeys() {
            activeVariantKeys = [];
            document.querySelectorAll('.variant-key-cb:checked').forEach(cb => { if (cb.value !== 'color') activeVariantKeys.push({ key: cb.value, label: cb.dataset.label }); });
        }

        async function loadVariants() {
            try {
                const res = await api.request(`/products/${productId}/variants`);
                allVariantsData = res.data || [];
                
                const stockInput = document.getElementById('p-stock');
                const stockBadge = document.getElementById('stock-source-badge');
                const stockHint = document.getElementById('stock-hint');
                
                if (allVariantsData.length > 0) {
                    stockInput.setAttribute('readonly', true); stockInput.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed'); stockInput.classList.remove('bg-white', 'text-gray-800'); stockBadge.classList.remove('hidden'); stockHint.classList.remove('hidden');
                    stockInput.value = allVariantsData.reduce((sum, v) => sum + (parseInt(v.stock_quantity)||0), 0);
                } else {
                    stockInput.removeAttribute('readonly'); stockInput.classList.remove('bg-gray-100', 'text-gray-500', 'cursor-not-allowed'); stockInput.classList.add('bg-white', 'text-gray-800'); stockBadge.classList.add('hidden'); stockHint.classList.add('hidden');
                }
                
                if (allVariantsData.length > 0) {
                    const sample = allVariantsData[0];
                    const attrs = sample.attributes || {};
                    document.querySelectorAll('.variant-key-cb').forEach(cb => { if (cb.value !== 'color') cb.checked = (attrs[cb.value] !== undefined && attrs[cb.value] !== ""); });
                    updateActiveKeys();
                }
                renderVariantsByGroup();
            } catch (e) { console.error(e); }
        }

        window.renderVariantsByGroup = () => {
            const container = document.getElementById('variant-groups-container');
            container.innerHTML = '';
            
            const groupsMap = new Map();
            allVariantsData.forEach(v => {
                let colorRaw = (v.attributes?.color || v.color || 'Mặc định').trim();
                let colorKey = colorRaw.toLowerCase();
                if (!groupsMap.has(colorKey)) {
                    groupsMap.set(colorKey, { displayName: colorRaw, items: [] });
                }
                groupsMap.get(colorKey).items.push(v);
            });

            groupsMap.forEach((groupData, colorKey) => {
                const firstItem = groupData.items[0];
                const colorCode = firstItem.color_code || firstItem.attributes?.color_code;
                
                container.insertAdjacentHTML('beforeend', buildGroupHTML(groupData.displayName, groupData.items, colorCode));
            });
        };

        function buildGroupHTML(colorName, variants, colorCode = '') {
            let groupImages = [];
            variants.forEach(v => {
                if (v.gallery?.length) v.gallery.forEach(img => !groupImages.includes(img) && groupImages.push(img));
                else if (v.image && !groupImages.includes(v.image)) groupImages.push(v.image);
            });
            
            const repId = (variants.length > 0 && variants[0].id) ? variants[0].id : '';
            const rowsHtml = variants.length > 0 
                ? variants.map(v => renderRowHtml(v)).join('') 
                : renderRowHtml({ attributes: {}, price: 0, stock_quantity: 0 });

            const galleryHtml = groupImages.length > 0
                ? groupImages.map(url => `<div class="relative aspect-square border rounded overflow-hidden group/img bg-white"><img src="../${url}" class="w-full h-full object-cover"><button onclick="removeVariantImage(this, '${url}')" class="absolute inset-0 bg-black/50 hidden group-hover/img:flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button></div>`).join('')
                : `<div class="col-span-4 text-[10px] text-center text-blue-500 bg-blue-50 p-2 rounded border border-blue-100 italic">Chưa có ảnh riêng.<br>Sẽ dùng bộ sưu tập chung.</div>`;

            return `
            <div class="border border-gray-300 rounded-lg overflow-hidden bg-white group-block mb-6" data-color="${colorName}">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-700">MÀU SẮC:</span>
                            <input type="text" class="color-input font-bold text-blue-700 bg-transparent border-b border-gray-400 w-32 px-1 outline-none" value="${colorName}" onchange="updateGroupColor(this)">
                        </div>
                        <div class="flex items-center gap-1 bg-white border border-gray-300 rounded px-2 py-1 shadow-sm">
                            <input type="color" class="w-6 h-6 border-none p-0 cursor-pointer group-color-picker" 
                                   value="${colorCode}" 
                                   oninput="this.nextElementSibling.value = this.value">
                            <input type="text" class="w-20 text-xs uppercase outline-none group-color-text font-mono" 
                                   value="${colorCode}" placeholder="#000000"
                                   oninput="this.previousElementSibling.value = this.value">
                        </div>
                    </div>
                    <button onclick="this.closest('.group-block').remove()" class="text-red-500 hover:text-red-700 text-sm"><i class="fa-solid fa-trash"></i> Xóa nhóm</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-4 divide-y lg:divide-y-0 lg:divide-x divide-gray-200">
                    <div class="p-4 lg:col-span-1 bg-gray-50/50">
                        <h5 class="text-xs font-bold text-gray-500 uppercase mb-3">Ảnh riêng (Ưu tiên)</h5>
                        <div class="grid grid-cols-4 gap-2 mb-3 group-gallery">${galleryHtml}</div>
                        ${repId 
                            ? `<label class="cursor-pointer flex items-center justify-center gap-2 w-full py-2 border border-dashed border-blue-300 rounded-lg text-blue-600 hover:bg-blue-50 text-xs font-bold transition"><i class="fa-solid fa-upload"></i> Tải ảnh riêng<input type="file" class="hidden" accept="image/*" multiple onchange="uploadGroupImages(this, ${repId})"></label>`
                            : `<div class="text-[10px] text-orange-600 text-center bg-orange-50 p-2 rounded border border-orange-200">Lưu biến thể trước để tải ảnh.</div>`
                        }
                    </div>
                    <div class="p-4 lg:col-span-3">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="text-xs font-bold text-gray-500 uppercase">Danh sách phân loại</h5>
                            <button onclick="addVariantRowToGroup(this)" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold hover:bg-green-200"><i class="fa-solid fa-plus"></i> Thêm dòng</button>
                        </div>
                        <table class="w-full text-sm text-left border-collapse border border-gray-200">
                            <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                                <tr>
                                    ${activeVariantKeys.map(k => `<th class="p-2 border">${k.label}</th>`).join('')}
                                    <th class="p-2 border w-32 text-right">Giá *</th>
                                    <th class="p-2 border w-24 text-center">Kho</th>
                                    <th class="p-2 border w-24">SKU</th>
                                    <th class="p-2 border w-10"></th>
                                </tr>
                            </thead>
                            <tbody class="group-tbody">${rowsHtml}</tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }

        function renderRowHtml(v) {
            const attrs = v.attributes || {};
            let cols = '';
            activeVariantKeys.forEach(k => {
                cols += `<td class="p-2 border"><input type="text" class="w-full px-2 py-1 border rounded text-sm attr-input" data-key="${k.key}" value="${attrs[k.key]||''}"></td>`;
            });
            return `<tr data-id="${v.id||''}" data-image="${v.image||''}">
                ${cols}
                <td class="p-2 border"><input type="number" class="w-full px-2 py-1 border rounded text-right price-input" value="${v.price||0}"></td>
                <td class="p-2 border"><input type="number" class="w-full px-2 py-1 border rounded text-center stock-input" value="${v.stock_quantity||0}"></td>
                <td class="p-2 border"><input type="text" class="w-full px-2 py-1 border rounded text-xs sku-input" value="${v.sku||''}"></td>
                <td class="p-2 border text-center"><button onclick="this.closest('tr').remove()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td>
            </tr>`;
        }

        window.addVariantGroup = () => {
            const container = document.getElementById('variant-groups-container');
            const newColor = 'Màu mới ' + (document.querySelectorAll('.group-block').length + 1);
            container.insertAdjacentHTML('beforeend', buildGroupHTML(newColor, [{id: null, attributes:{}, price:0, stock_quantity:0}]));
            container.lastElementChild.scrollIntoView({ behavior: 'smooth' });
        };
        window.addVariantRowToGroup = (btn) => {
            btn.closest('.p-4').querySelector('.group-tbody').insertAdjacentHTML('beforeend', renderRowHtml({attributes:{}, price:0, stock_quantity:0}));
        };
        window.updateGroupColor = (input) => input.closest('.group-block').dataset.color = input.value;

        window.uploadGroupImages = async (input, variantId) => {
            if (!variantId) return showToast('Vui lòng lưu trước!', 'warning');
            for (let file of input.files) {
                const fd = new FormData();
                fd.append('image', file);
                fd.append('variant_id', variantId);
                await api.uploadProductImage(productId, fd);
            }
            showToast('Đã tải ảnh lên', 'success');
            await loadVariants();
        };

        window.removeVariantImage = async (btn, url) => {
            if (!confirm('Xóa ảnh này?')) return;
            try {
                await api.request('/products/delete-image', { method: 'POST', auth: true, body: { image_url: url } });
                btn.closest('div').remove();
                showToast('Đã xóa', 'success');
            } catch (e) { showToast('Lỗi xóa', 'error'); }
        };

        window.saveVariants = async () => {
            const payload = [];
            const seenColors = new Set(); 
            let hasDuplicate = false;

            document.querySelectorAll('.group-block').forEach(group => {
                const colorRaw = group.querySelector('.color-input').value.trim();
                const colorKey = colorRaw.toLowerCase();
                const groupColorCode = group.querySelector('.group-color-text').value.trim();

                if (seenColors.has(colorKey)) {
                    hasDuplicate = true;
                    group.querySelector('.color-input').classList.add('bg-red-100', 'text-red-700');
                } else {
                    seenColors.add(colorKey);
                    group.querySelector('.color-input').classList.remove('bg-red-100', 'text-red-700');
                }

                const firstImg = group.querySelector('.group-gallery img')?.getAttribute('src')?.replace('../', '') || '';
                
                group.querySelectorAll('tbody tr').forEach(tr => {
                    const price = tr.querySelector('.price-input').value;
                    if (!price) return;
                    
                    const attrs = { color: colorRaw };
                    tr.querySelectorAll('.attr-input').forEach(i => attrs[i.dataset.key] = i.value.trim());

                    payload.push({
                        id: tr.dataset.id || null, 
                        attributes: attrs, 
                        color_code: groupColorCode,
                        price: price,
                        stock_quantity: tr.querySelector('.stock-input').value,
                        sku: tr.querySelector('.sku-input').value, 
                        image: firstImg
                    });
                });
            });

            if (hasDuplicate) return showToast('Lỗi: Tên màu không được trùng nhau.', 'error');
            if (payload.length === 0 && !confirm('Bạn đang xóa TẤT CẢ biến thể. Tiếp tục?')) return;

            try {
                await api.request(`/products/${productId}/variants/save`, { method: 'POST', auth: true, body: payload });
                showToast('Lưu thành công!', 'success');
                await loadVariants(); 
                const p = await api.getProduct(productId);
                const stockInput = document.getElementById('p-stock');
                stockInput.value = p.stock_quantity;
                if (payload.length === 0) {
                    stockInput.removeAttribute('readonly'); stockInput.classList.remove('bg-gray-100', 'text-gray-500', 'cursor-not-allowed'); stockInput.classList.add('bg-white', 'text-gray-800'); document.getElementById('stock-source-badge').classList.add('hidden'); document.getElementById('stock-hint').classList.add('hidden');
                }
            } catch (e) { showToast(e.message || 'Lỗi lưu', 'error'); }
        };

        // =========================================================
        // HÀM LOAD & UPDATE HÃNG SẢN XUẤT (BRAND)
        // =========================================================
        async function loadCategoriesAndInit(selectedCategorySlug, selectedBrandName) {
            const res = await api.getCategories();
            allCategories = res.data || [];
            const catSelect = document.getElementById('p-category');
            
            catSelect.innerHTML = '<option value="">-- Chọn danh mục --</option>' +
                allCategories.map(c => `<option value="${c.slug}" ${c.slug === selectedCategorySlug ? 'selected' : ''}>${c.name}</option>`).join('');

            catSelect.addEventListener('change', async function() {
                await updateBrandSelect(this.value);
            });

            // Initial load brands
            if (selectedCategorySlug) {
                await updateBrandSelect(selectedCategorySlug, selectedBrandName);
            }
        }

        async function updateBrandSelect(categorySlug, selectedBrand = '') {
            const brandSelect = document.getElementById('p-brand');
            brandSelect.innerHTML = '<option value="">Đang tải...</option>';
            brandSelect.disabled = true;

            try {
                const res = await api.getBrands(categorySlug);
                const brands = res.data || [];
                
                brandSelect.innerHTML = '<option value="">-- Chọn hãng --</option>';
                
                if (brands.length > 0) {
                    brandSelect.disabled = false;
                    brands.forEach(b => {
                        const bName = typeof b === 'object' ? b.name : b; 
                        brandSelect.innerHTML += `<option value="${bName}" ${bName === selectedBrand ? 'selected' : ''}>${bName}</option>`;
                    });
                } else {
                    brandSelect.innerHTML = '<option value="">Không có hãng</option>';
                }
            } catch(e) {
                console.error(e);
                brandSelect.innerHTML = '<option value="">Lỗi tải</option>';
            }
        }

        function renderSpecsForm(template, data) {
            const container = document.getElementById('specs-container');
            container.innerHTML = template ? template.map(g => `<div class="border p-4 rounded mb-4"><h4 class="font-bold mb-2">${g.group}</h4><div class="grid grid-cols-2 gap-4">${(g.fields||[]).map(f => `<div><label class="text-xs uppercase text-gray-500 font-bold">${f.l}</label><input type="text" class="w-full border rounded px-2 py-1 spec-input" data-key="${f.k}" value="${data[f.k]||''}"></div>`).join('')}</div></div>`).join('') : '<p class="text-gray-400 italic">Không có template thông số cho danh mục này.</p>';
        }

        window.saveAllChanges = async () => {
            document.querySelectorAll('.spec-input').forEach(i => currentSpecsData[i.dataset.key] = i.value);
            const data = {
                title: document.getElementById('p-title').value,
                price: document.getElementById('p-price').value,
                category: document.getElementById('p-category').value,
                brand: document.getElementById('p-brand').value, // LƯU BRAND
                description: document.getElementById('p-desc').value,
                image: document.getElementById('p-image').value,
                specs: currentSpecsData,
                is_active: document.getElementById('p-is-active').checked ? 1 : 0,
                ...(document.getElementById('p-stock').hasAttribute('readonly') ? {} : { stock_quantity: document.getElementById('p-stock').value })
            };
            try {
                await api.updateProduct(productId, data);
                showToast('Đã lưu thông tin chung', 'success');
            } catch (e) { showToast('Lỗi: ' + e.message, 'error'); }
        };

        initPage();
    </script>
</body>
</html>