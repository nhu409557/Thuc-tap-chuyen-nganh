<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt S·∫£n ph·∫©m - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #toast-root { z-index: 9999 !important; position: fixed; top: 20px; right: 20px; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="products.html" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-xl font-bold text-gray-800" id="page-title">ƒêang t·∫£i...</h1>
                <p class="text-xs text-gray-500" id="page-id">ID: ...</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="saveAllChanges()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition flex items-center gap-2">
                <i class="fa-solid fa-floppy-disk"></i> L∆∞u thay ƒë·ªïi
            </button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="space-y-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Th√¥ng tin chung</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n s·∫£n ph·∫©m <span class="text-red-500">*</span></label>
                        <input type="text" id="p-title" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gi√° b√°n (VNƒê)</label>
                            <input type="number" id="p-price" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-blue-600">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gi√° g·ªëc</label>
                            <input type="number" id="p-compare" class="w-full px-3 py-2 border rounded-lg outline-none text-gray-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">T·ªìn kho</label>
                            <input type="number" id="p-stock" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-gray-800" placeholder="0">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Danh m·ª•c</label>
                            <select id="p-category" class="w-full px-3 py-2 border rounded-lg outline-none bg-white cursor-pointer hover:bg-gray-50 transition">
                                <option value="">-- ƒêang t·∫£i... --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">H√£ng</label>
                            <select id="p-brand" class="w-full px-3 py-2 border rounded-lg outline-none bg-white cursor-pointer">
                                <option value="">-- Ch·ªçn h√£ng --</option>
                            </select>
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">·∫¢nh ƒë·∫°i di·ªán</label>
                        <div class="flex gap-4 items-center">
                            <label class="relative group w-24 h-24 flex-shrink-0 cursor-pointer border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition flex items-center justify-center overflow-hidden bg-white">
                                <img id="preview-main-img" src="https://placehold.co/150?text=Upload" class="w-full h-full object-contain p-1">
                                <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                    <i class="fa-solid fa-camera text-white text-xl"></i>
                                </div>
                                <input type="file" id="main-image-upload" class="hidden" accept="image/*">
                            </label>
                            <div class="flex-1 space-y-2">
                                <p class="text-xs text-gray-500">Click ·∫£nh ƒë·ªÉ t·∫£i l√™n.<br>JPG, PNG. Max 2MB.</p>
                                <div class="relative">
                                    <input type="text" id="p-image" class="w-full pl-7 pr-3 py-1.5 text-xs border border-gray-200 rounded bg-gray-50 text-gray-500 outline-none" readonly placeholder="Link ·∫£nh...">
                                    <i class="fa-solid fa-link absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">M√¥ t·∫£ ng·∫Øn</label>
                        <textarea id="p-desc" rows="4" class="w-full px-3 py-2 border rounded-lg outline-none text-sm"></textarea>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="font-bold text-gray-800">Th∆∞ vi·ªán ·∫£nh ph·ª•</h3>
                    <label class="cursor-pointer bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Th√™m ·∫£nh
                        <input type="file" id="gallery-upload-input" class="hidden" accept="image/*">
                    </label>
                </div>
                <div id="gallery-grid" class="grid grid-cols-3 gap-3"></div>
                <p class="text-xs text-gray-400 mt-3 italic text-center">·∫¢nh ƒë∆∞·ª£c l∆∞u t·∫°i server.</p>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-h-screen">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="font-bold text-gray-800 text-lg">Th√¥ng s·ªë k·ªπ thu·∫≠t</h3>
                    <span class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold uppercase tracking-wide" id="specs-type-badge">...</span>
                </div>
                
                <div id="specs-container" class="space-y-6 animate-fade-in">
                    <p class="text-center text-gray-400 py-10">ƒêang t·∫£i bi·ªÉu m·∫´u c·∫•u h√¨nh...</p>
                </div>
            </div>
        </div>

    </main>

    <div id="toast-root" class="fixed top-5 right-5 z-[9999] flex flex-col gap-3"></div>

    <script type="module">
        const BASE_PATH = '../'; 

        import { renderAdminLayout, formatPrice } from '../assets/js/admin.js'; 
        import { api } from '../assets/js/api.js';
        import { getQueryParam } from '../assets/js/utils/url.js';
        import { showToast } from '../assets/js/ui/toast.js';

        // Render Sidebar
        renderAdminLayout('products');

        const productId = getQueryParam('id');
        
        // Bi·∫øn to√†n c·ª•c l∆∞u th√¥ng tin
        let currentSpecsData = {}; 
        let allCategories = []; // L∆∞u danh s√°ch danh m·ª•c ƒë·ªÉ tra c·ª©u template

        // ============================================================
        // 1. KH·ªûI T·∫†O TRANG
        // ============================================================
        async function initPage() {
            if(!productId) { 
                alert('Thi·∫øu ID s·∫£n ph·∫©m'); window.location.href = 'products.html'; return; 
            }

            try {
                // A. Load d·ªØ li·ªáu s·∫£n ph·∫©m
                const p = await api.getProduct(productId);
                
                // B. Fill th√¥ng tin c∆° b·∫£n
                document.getElementById('page-title').textContent = p.title;
                document.getElementById('page-id').textContent = 'ID: ' + p.id;
                document.getElementById('p-title').value = p.title || '';
                document.getElementById('p-price').value = p.price || 0;
                document.getElementById('p-compare').value = p.compare_at || '';
                document.getElementById('p-desc').value = p.description || '';
                document.getElementById('p-stock').value = p.stock_quantity || 0;

                // C. Fill ·∫£nh ch√≠nh
                document.getElementById('p-image').value = p.image || '';
                let displayImg = p.image;
                if (displayImg && !displayImg.startsWith('http') && !displayImg.startsWith('/')) {
                    displayImg = BASE_PATH + '/' + displayImg;
                }
                document.getElementById('preview-main-img').src = displayImg || 'https://placehold.co/150?text=Upload';

                // D. Parse Specs Data hi·ªán c√≥ c·ªßa s·∫£n ph·∫©m
                try { currentSpecsData = typeof p.specs === 'string' ? JSON.parse(p.specs) : (p.specs || {}); } catch(e) { currentSpecsData = {}; }

                // E. Load Danh m·ª•c & H√£ng & V·∫Ω Form Specs
                // B∆∞·ªõc 1: T·∫£i danh s√°ch Categories (ƒë·ªÉ l·∫•y Template)
                await loadCategoriesAndInit(p.category, p.brand);

                // F. Render Gallery
                const gallery = (p.gallery && p.gallery.length > 0) ? p.gallery : (p.image ? [p.image] : []);
                renderGallery(gallery);

            } catch (e) { 
                console.error(e); 
                showToast('L·ªói t·∫£i d·ªØ li·ªáu: ' + e.message, 'error'); 
            }
        }

        // ============================================================
        // 2. LOGIC LOAD DANH M·ª§C & X·ª¨ L√ù LOGIC ƒê·ªòNG
        // ============================================================
        async function loadCategoriesAndInit(selectedCategorySlug, selectedBrandName) {
            const catSelect = document.getElementById('p-category');
            catSelect.innerHTML = '<option value="">ƒêang t·∫£i...</option>';
            
            try {
                const res = await api.getCategories();
                allCategories = res.data || []; // L∆∞u v√†o bi·∫øn to√†n c·ª•c
                
                // Render dropdown
                catSelect.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i --</option>';
                allCategories.forEach(c => {
                    const isSelected = c.slug === selectedCategorySlug ? 'selected' : '';
                    catSelect.innerHTML += `<option value="${c.slug}" ${isSelected}>${c.name}</option>`;
                });

                // Sau khi c√≥ categories, g·ªçi h√†m v·∫Ω form specs v√† load h√£ng
                await handleCategoryChange(selectedCategorySlug, selectedBrandName);

            } catch (e) {
                console.error("L·ªói t·∫£i danh m·ª•c", e);
                catSelect.innerHTML = '<option value="">L·ªói t·∫£i danh m·ª•c</option>';
            }
        }

        // ============================================================
        // 3. H√ÄM X·ª¨ L√ù KHI ƒê·ªîI DANH M·ª§C (L·∫§Y TEMPLATE T·ª™ DB)
        // ============================================================
        async function handleCategoryChange(categorySlug, selectedBrand = '') {
            // 1. C·∫≠p nh·∫≠t Badge t√™n danh m·ª•c
            const categoryObj = allCategories.find(c => c.slug === categorySlug);
            const badge = document.getElementById('specs-type-badge');
            if(categoryObj) {
                badge.textContent = categoryObj.name;
            } else {
                badge.textContent = 'Ch∆∞a ch·ªçn';
            }

            // 2. Load H√£ng t∆∞∆°ng ·ª©ng
            await loadBrandsForDetail(categorySlug, selectedBrand);

            // 3. Render Form Specs t·ª´ Template
            let template = [];
            if (categoryObj && categoryObj.specs_template) {
                try { 
                    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p JSON string ho·∫∑c Object
                    template = typeof categoryObj.specs_template === 'string' 
                        ? JSON.parse(categoryObj.specs_template) 
                        : categoryObj.specs_template; 
                } catch(e){
                    console.error("L·ªói parse template", e);
                }
            }

            renderSpecsForm(template, currentSpecsData);
        }

        // S·ª± ki·ªán onChange c·ªßa dropdown
        document.getElementById('p-category').addEventListener('change', function() {
            // Khi user t·ª± ƒë·ªïi danh m·ª•c, ta gi·ªØ l·∫°i data ƒë√£ nh·∫≠p (currentSpecsData) 
            // nh∆∞ng form s·∫Ω v·∫Ω l·∫°i theo template m·ªõi.
            handleCategoryChange(this.value);
        });

        // ============================================================
        // 4. H√ÄM V·∫º FORM SPECS (BUILDER RENDERER)
        // ============================================================
        function renderSpecsForm(template, data) {
            const container = document.getElementById('specs-container');
            container.innerHTML = '';

            if (!template || !Array.isArray(template) || template.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center border border-dashed border-gray-300 rounded-lg bg-gray-50">
                        <p class="text-gray-500 italic">Danh m·ª•c n√†y ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh th√¥ng s·ªë k·ªπ thu·∫≠t.</p>
                        <a href="categories.html" class="text-blue-600 text-sm underline hover:text-blue-800 block mt-2" target="_blank">
                            ƒêi t·ªõi trang c·∫•u h√¨nh danh m·ª•c
                        </a>
                    </div>`;
                return;
            }

            template.forEach(group => {
                let fieldsHtml = '';
                
                if (group.fields && Array.isArray(group.fields)) {
                    group.fields.forEach(f => {
                        // L·∫•y gi√° tr·ªã hi·ªán t·∫°i (n·∫øu c√≥)
                        const val = data[f.k] || ''; 
                        
                        fieldsHtml += `
                            <div>
                                <label class="block text-[11px] font-bold text-gray-500 mb-1 uppercase tracking-wide">${f.l}</label>
                                <input type="text" name="spec_${f.k}" value="${val}" 
                                    class="w-full px-3 py-2 border border-gray-200 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-gray-50 focus:bg-white transition-colors placeholder-gray-300 shadow-sm"
                                    oninput="updateSpecData('${f.k}', this.value)"> 
                            </div>`;
                    });
                }

                container.innerHTML += `
                    <div class="border border-gray-200 rounded-lg p-5 bg-white shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-gray-100 pb-2">
                            <span class="w-1.5 h-4 bg-blue-600 rounded-full"></span>
                            ${group.group}
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            ${fieldsHtml}
                        </div>
                    </div>`;
            });
        }

        // Helper c·∫≠p nh·∫≠t data khi g√µ
        window.updateSpecData = (key, value) => {
            currentSpecsData[key] = value;
        };

        // ============================================================
        // 5. LOAD H√ÉNG
        // ============================================================
        async function loadBrandsForDetail(category, selectedBrand) {
            const brandSelect = document.getElementById('p-brand');
            brandSelect.disabled = true;
            brandSelect.innerHTML = '<option value="">ƒêang t·∫£i...</option>';

            try {
                const res = await api.getAllBrandsAdmin();
                let brands = res.data || [];
                
                brandSelect.innerHTML = '<option value="">-- Ch·ªçn h√£ng --</option>';
                
                if (brands.length > 0) {
                    // L·ªçc h√£ng theo danh m·ª•c (D·ª±a v√†o chu·ªói categories l∆∞u trong b·∫£ng brands)
                    if (category && category !== 'all') {
                        brands = brands.filter(b => b.categories && b.categories.includes(category));
                    }

                    if (brands.length > 0) {
                        brandSelect.disabled = false;
                        brands.forEach(b => {
                            const bName = (typeof b === 'object' && b.name) ? b.name : b;
                            const selected = (bName == selectedBrand) ? 'selected' : '';
                            brandSelect.innerHTML += `<option value="${bName}" ${selected}>${bName}</option>`;
                        });
                    } else {
                        brandSelect.innerHTML = '<option value="">Kh√¥ng c√≥ h√£ng ph√π h·ª£p</option>';
                    }
                } else {
                    brandSelect.innerHTML = '<option value="">Ch∆∞a c√≥ d·ªØ li·ªáu h√£ng</option>';
                }
            } catch(e) {
                brandSelect.innerHTML = '<option value="">L·ªói t·∫£i h√£ng</option>';
            }
        }

        // ============================================================
        // 6. X·ª¨ L√ù UPLOAD ·∫¢NH
        // ============================================================
        
        // Upload ·∫¢nh Ch√≠nh
        const mainImageInput = document.getElementById('main-image-upload');
        if (mainImageInput) {
            mainImageInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Preview
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('preview-main-img').src = e.target.result; };
                reader.readAsDataURL(file);

                // Upload
                const formData = new FormData();
                formData.append('image', file);
                
                showToast('ƒêang t·∫£i ·∫£nh l√™n...', 'info');
                mainImageInput.disabled = true;

                try {
                    // Upload t·∫°m v√†o s·∫£n ph·∫©m (n·∫øu ƒë√£ c√≥ ID) ho·∫∑c d√πng API upload chung
                    const targetId = productId || 0;
                    const data = await api.uploadProductImage(targetId, formData);
                    
                    if(data.success) {
                        document.getElementById('p-image').value = data.url; // Update link v√†o √¥ input
                        showToast('ƒê√£ t·∫£i ·∫£nh l√™n!', 'success');
                    } else {
                        showToast(data.error || 'L·ªói upload', 'error');
                    }
                } catch(e) {
                    showToast('L·ªói k·∫øt n·ªëi server', 'error');
                } finally {
                    mainImageInput.disabled = false;
                }
            });
        }

        // Upload ·∫¢nh Gallery (Ph·ª•)
        const galleryUploadInput = document.getElementById('gallery-upload-input');
        if(galleryUploadInput) {
            galleryUploadInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if(!file) return;
                
                const formData = new FormData();
                formData.append('image', file);
                
                showToast('ƒêang t·∫£i ·∫£nh gallery...', 'info');
                try {
                    const data = await api.uploadProductImage(productId, formData);
                    if(data.success) {
                        showToast('Upload th√†nh c√¥ng!', 'success');
                        setTimeout(() => location.reload(), 1000); // Reload ƒë·ªÉ th·∫•y ·∫£nh m·ªõi
                    } else { 
                        showToast(data.error || 'L·ªói upload', 'error'); 
                    }
                } catch(e) { showToast('L·ªói k·∫øt n·ªëi server', 'error'); }
            });
        }

        // Render Gallery
        function renderGallery(images) {
            const container = document.getElementById('gallery-grid');
            if(!container) return;

            const validImages = images.filter(img => img && img !== 'https://via.placeholder.com/300');
            
            if (validImages.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 col-span-3 text-center">Ch∆∞a c√≥ ·∫£nh n√†o.</p>';
                return;
            }

            container.innerHTML = validImages.map(img => {
                let displayUrl = img;
                if (!img.startsWith('http') && !img.startsWith('/')) {
                    displayUrl = BASE_PATH + '/' + img;
                }
                return `
                <div class="relative group h-24 border rounded-lg overflow-hidden bg-gray-50 shadow-sm">
                    <img src="${displayUrl}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/150?text=Err'">
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2 backdrop-blur-sm">
                        <a href="${displayUrl}" target="_blank" class="text-white hover:text-blue-300 p-1"><i class="fa-solid fa-eye"></i></a>
                        <button onclick="window.deleteImage('${img}')" class="text-white hover:text-red-400 p-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        window.deleteImage = async (imageUrl) => {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh n√†y?')) return;
            try {
                await api.deleteProductImage(imageUrl);
                showToast('ƒê√£ x√≥a ·∫£nh th√†nh c√¥ng', 'success');
                setTimeout(() => location.reload(), 800);
            } catch (e) { showToast('L·ªói x√≥a ·∫£nh: ' + e.message, 'error'); }
        };

        // ============================================================
        // 7. L∆ØU D·ªÆ LI·ªÜU
        // ============================================================
        window.saveAllChanges = async () => {
            const btn = document.querySelector('button[onclick="saveAllChanges()"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang l∆∞u...';

            // Data Object
            const data = {
                title: document.getElementById('p-title').value,
                price: document.getElementById('p-price').value,
                stock_quantity: document.getElementById('p-stock').value,
                compare_at: document.getElementById('p-compare').value,
                category: document.getElementById('p-category').value,
                brand: document.getElementById('p-brand').value,
                image: document.getElementById('p-image').value,
                description: document.getElementById('p-desc').value,
                // G·ª≠i object specs (Backend s·∫Ω t·ª± encode JSON)
                specs: currentSpecsData 
            };

            try {
                await api.updateProduct(productId, data);
                showToast('C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng! üéâ', 'success');
            } catch(e) {
                showToast('L·ªói l∆∞u d·ªØ li·ªáu: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // Ch·∫°y
        initPage();
    </script>
</body>
</html>