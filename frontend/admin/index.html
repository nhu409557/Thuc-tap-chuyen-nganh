<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pro - TechHub Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

    <div class="p-4 lg:p-8 max-w-[1600px] mx-auto">
        
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">T·ªïng quan kinh doanh</h1>
                <p class="text-sm text-slate-500 mt-1">Ch√†o m·ª´ng quay tr·ªü l·∫°i, ƒë√¢y l√† s·ªë li·ªáu h√¥m nay.</p>
            </div>
            
            <div class="flex gap-2">
                <select id="revenue-filter" class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5 shadow-sm outline-none">
                    <option value="day">üìÖ H√¥m nay</option>
                    <option value="month" selected>üìÖ Th√°ng n√†y</option>
                    <option value="year">üìÖ NƒÉm nay</option>
                    <option value="all">üìä To√†n b·ªô</option>
                </select>
                <button id="btn-export-excel" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg text-sm font-medium shadow-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-download"></i> <span id="btn-export-text">Xu·∫•t b√°o c√°o</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm card-hover transition duration-300">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-slate-400 uppercase">Doanh thu</p>
                        <h3 class="text-2xl font-bold text-slate-800 mt-1" id="stat-revenue">0 ƒë</h3>
                    </div>
                    <div class="p-3 bg-blue-50 rounded-lg text-blue-600"><i class="fa-solid fa-money-bill-wave text-xl"></i></div>
                </div>
                <div class="mt-4 flex items-center text-xs text-green-600 bg-green-50 px-2 py-1 rounded w-fit">
                    <i class="fa-solid fa-arrow-trend-up mr-1"></i> <span id="revenue-label">Th√°ng n√†y</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm card-hover transition duration-300">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-slate-400 uppercase">T·ªïng ƒë∆°n h√†ng</p>
                        <h3 class="text-2xl font-bold text-slate-800 mt-1" id="stat-orders">0</h3>
                    </div>
                    <div class="p-3 bg-purple-50 rounded-lg text-purple-600"><i class="fa-solid fa-cart-shopping text-xl"></i></div>
                </div>
                 <div class="mt-4 flex items-center text-xs text-slate-400">
                    <span>T·ªïng s·ªë ƒë∆°n tr√™n h·ªá th·ªëng</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm card-hover transition duration-300">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-slate-400 uppercase">Kh√°ch h√†ng</p>
                        <h3 class="text-2xl font-bold text-slate-800 mt-1" id="stat-users">0</h3>
                    </div>
                    <div class="p-3 bg-orange-50 rounded-lg text-orange-600"><i class="fa-solid fa-users text-xl"></i></div>
                </div>
                <div class="mt-4 flex items-center text-xs text-slate-400">
                    <span>T√†i kho·∫£n ƒëƒÉng k√Ω</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm card-hover transition duration-300">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-slate-400 uppercase">ƒê√£ giao th√†nh c√¥ng</p>
                        <h3 class="text-2xl font-bold text-green-600 mt-1" id="stat-success-rate">0%</h3>
                    </div>
                    <div class="p-3 bg-green-50 rounded-lg text-green-600"><i class="fa-solid fa-check-double text-xl"></i></div>
                </div>
                <div class="mt-4 flex items-center text-xs text-slate-400">
                    <span>T·ª∑ l·ªá ƒë∆°n h√†ng th√†nh c√¥ng</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-4">Bi·ªÉu ƒë·ªì doanh thu (7 ng√†y g·∫ßn nh·∫•t)</h3>
                <div class="relative h-64 lg:h-80 w-full">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                <h3 class="font-bold text-slate-800 mb-4">Tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
                <div class="relative h-64 w-full flex-1 flex items-center justify-center">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="font-bold text-slate-800">üèÜ Top S·∫£n ph·∫©m b√°n ch·∫°y</h3>
                    <a href="products.html" class="text-xs font-medium text-blue-600 hover:underline">Xem t·∫•t c·∫£</a>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                            <tr>
                                <th class="px-4 py-3">S·∫£n ph·∫©m</th>
                                <th class="px-4 py-3 text-center">ƒê√£ b√°n</th>
                                <th class="px-4 py-3 text-right">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody id="top-products-list" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="font-bold text-slate-800">üïí ƒê∆°n h√†ng m·ªõi nh·∫•t</h3>
                    <a href="orders.html" class="text-xs font-medium text-blue-600 hover:underline">Qu·∫£n l√Ω ƒë∆°n</a>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                            <tr>
                                <th class="px-4 py-3">M√£ ƒë∆°n</th>
                                <th class="px-4 py-3">Kh√°ch h√†ng</th>
                                <th class="px-4 py-3">Tr·∫°ng th√°i</th>
                                <th class="px-4 py-3 text-right">T·ªïng ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders-list" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-red-50/50 border border-red-100 rounded-xl p-6 shadow-sm mb-8">
            <h3 class="font-bold text-red-600 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-triangle-exclamation"></i> C·∫£nh b√°o t·ªìn kho th·∫•p (<= 5)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="low-stock-list">
                </div>
        </div>

    </div>

    <script type="module">
        import { renderAdminLayout, formatPrice } from '../assets/js/admin.js';
        import { api } from '../assets/js/api.js';
        import { showToast } from '../assets/js/ui/toast.js';

        let cachedStats = null;
        let revenueChartInstance = null;
        let statusChartInstance = null;

        // Render layout chung
        try { await renderAdminLayout('dashboard'); } catch (e) {}

        async function loadDashboard() {
            try {
                const data = await api.request('/admin/stats', { auth: true });
                cachedStats = data;

                // 1. Fill KPI Cards
                document.getElementById('stat-orders').textContent = data.total_orders;
                document.getElementById('stat-users').textContent = data.total_customers;
                
                // T√≠nh t·ª∑ l·ªá th√†nh c√¥ng
                const delivered = data.order_stats.Delivered || 0;
                const total = data.total_orders || 1; 
                const rate = ((delivered / total) * 100).toFixed(1);
                document.getElementById('stat-success-rate').textContent = rate + '%';

                // 2. Render Charts
                renderRevenueChart(data.chart_data);
                renderStatusChart(data.order_stats);

                // 3. Render Tables
                renderTopProducts(data.top_products);
                renderRecentOrders(data.recent_orders);
                renderLowStock(data.low_stock_products);

                // 4. Update Revenue m·∫∑c ƒë·ªãnh
                updateRevenueDisplay();

            } catch (err) {
                console.error(err);
                showToast('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Dashboard.', 'error');
            }
        }

        // --- CHART 1: LINE CHART (Doanh thu) ---
        function renderRevenueChart(chartData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if(revenueChartInstance) revenueChartInstance.destroy();

            // Gradient fill cho ƒë·∫πp
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Blue
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            revenueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Doanh thu (VNƒê)',
                        data: chartData.data,
                        borderColor: '#2563eb', // Blue-600
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#2563eb',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4 // L√†m m∆∞·ª£t ƒë∆∞·ªùng cong
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatPrice(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [2, 4], color: '#e2e8f0' },
                            ticks: { callback: (value) => value.toLocaleString('vi-VN', {notation: 'compact'}) }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- CHART 2: DOUGHNUT CHART (Tr·∫°ng th√°i) ---
        function renderStatusChart(stats) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            if(statusChartInstance) statusChartInstance.destroy();

            const labels = {
                'Pending': 'Ch·ªù x√°c nh·∫≠n',
                'Confirmed': 'ƒê√£ x√°c nh·∫≠n',
                'Shipping': 'ƒêang giao',
                'Delivered': 'Ho√†n th√†nh',
                'Cancelled': 'ƒê√£ h·ªßy',
                'Returned': 'Tr·∫£ h√†ng'
            };

            const dataValues = [
                stats.Pending || 0,
                stats.Confirmed || 0,
                stats.Shipping || 0,
                stats.Delivered || 0,
                stats.Cancelled || 0,
                stats.Returned || 0
            ];

            statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.values(labels),
                    datasets: [{
                        data: dataValues,
                        backgroundColor: [
                            '#fbbf24', // Amber (Pending)
                            '#60a5fa', // Blue (Confirmed)
                            '#3b82f6', // Dark Blue (Shipping)
                            '#22c55e', // Green (Delivered)
                            '#ef4444', // Red (Cancelled)
                            '#94a3b8'  // Gray (Returned)
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } }
                    },
                    cutout: '70%' // L√†m v√≤ng tr√≤n m·ªèng h∆°n
                }
            });
        }

        // --- RENDER TABLES ---
        function renderTopProducts(products) {
            const list = document.getElementById('top-products-list');
            if(!products?.length) {
                list.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-slate-400">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`;
                return;
            }
            list.innerHTML = products.map((p, index) => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-400">#${index+1}</span>
                            <img src="../${p.image || 'assets/images/no-image.png'}" class="w-8 h-8 rounded object-cover border border-slate-200" onerror="this.src='../assets/images/no-image.png'">
                            <span class="font-medium text-slate-700 truncate max-w-[150px]" title="${p.title}">${p.title}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center font-semibold text-slate-600">${p.total_sold}</td>
                    <td class="px-4 py-3 text-right text-blue-600 font-medium">${formatPrice(p.total_revenue)}</td>
                </tr>
            `).join('');
        }

        function renderRecentOrders(orders) {
            const list = document.getElementById('recent-orders-list');
            if(!orders?.length) {
                list.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-slate-400">Ch∆∞a c√≥ ƒë∆°n h√†ng</td></tr>`;
                return;
            }
            const statusColors = {
                'Pending': 'bg-yellow-100 text-yellow-700',
                'Confirmed': 'bg-blue-100 text-blue-700',
                'Shipping': 'bg-indigo-100 text-indigo-700',
                'Delivered': 'bg-green-100 text-green-700',
                'Cancelled': 'bg-red-100 text-red-700',
                'Returned': 'bg-gray-100 text-gray-700'
            };

            list.innerHTML = orders.map(o => `
                <tr class="hover:bg-slate-50 transition cursor-pointer" onclick="window.location.href='orders.html?id=${o.id}'">
                    <td class="px-4 py-3 font-mono text-xs text-slate-500">#${o.id}</td>
                    <td class="px-4 py-3 font-medium text-slate-700">${o.name}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusColors[o.status] || 'bg-gray-100'}">${o.status}</span>
                    </td>
                    <td class="px-4 py-3 text-right font-medium text-slate-800">${formatPrice(o.total_amount)}</td>
                </tr>
            `).join('');
        }

        function renderLowStock(products) {
            const list = document.getElementById('low-stock-list');
            if(!products?.length) {
                list.innerHTML = `<div class="col-span-full text-center text-slate-400 italic">Kho h√†ng ·ªïn ƒë·ªãnh</div>`;
                return;
            }
            list.innerHTML = products.map(p => `
                <div class="flex items-center gap-3 p-3 bg-white rounded-lg border border-red-200 shadow-sm">
                    <img src="../${p.image}" class="w-10 h-10 rounded object-cover" onerror="this.src='../assets/images/no-image.png'">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-800 truncate">${p.title}</p>
                        <p class="text-xs text-red-500 font-bold">C√≤n l·∫°i: ${p.stock_quantity}</p>
                    </div>
                    <a href="products.html" class="text-xs text-blue-600 hover:underline">Nh·∫≠p</a>
                </div>
            `).join('');
        }

        // --- FILTER LOGIC ---
        function updateRevenueDisplay() {
            if (!cachedStats) return;
            const filter = document.getElementById('revenue-filter').value;
            const displayEl = document.getElementById('stat-revenue');
            const labelEl = document.getElementById('revenue-label');
            
            const map = {
                'day': { val: cachedStats.revenue.day, label: 'H√¥m nay' },
                'month': { val: cachedStats.revenue.month, label: 'Th√°ng n√†y' },
                'year': { val: cachedStats.revenue.year, label: 'NƒÉm nay' },
                'all': { val: cachedStats.revenue.all, label: 'To√†n b·ªô' }
            };

            displayEl.textContent = formatPrice(map[filter].val || 0);
            labelEl.textContent = map[filter].label;
        }

        document.getElementById('revenue-filter').addEventListener('change', updateRevenueDisplay);

        // Export Logic
        document.getElementById('btn-export-excel').addEventListener('click', async function() {
            const btn = this;
            const filterType = document.getElementById('revenue-filter').value;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Xu·∫•t file...`;
            btn.disabled = true;

            try {
                await api.exportRevenue(filterType);
                showToast('ƒê√£ t·∫£i xu·ªëng file b√°o c√°o!', 'success');
            } catch (err) {
                showToast('L·ªói xu·∫•t file: ' + err.message, 'error');
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        });

        loadDashboard();
    </script>
</body>
</html>