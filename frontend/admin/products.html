<!DOCTYPE html> 
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sản phẩm - TechHub Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .modal-scroll::-webkit-scrollbar { width: 6px; }
        .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #6b7280; border-bottom: 2px solid transparent; }
        
        .read-only-input {
            background-color: #f9fafb;
            border-color: #e5e7eb;
            color: #4b5563;
            pointer-events: none;
        }
        
        input:read-only, textarea:read-only, select:disabled {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Quản lý Sản phẩm</h1>
            <p class="text-sm text-gray-500">Kho hàng và cấu hình chi tiết</p>
        </div>
        <button id="btn-add" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 flex items-center gap-2 shadow-lg shadow-blue-500/30 transition-all hover:-translate-y-0.5">
            <i class="fa-solid fa-plus"></i> Thêm mới
        </button>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-4 border-b border-gray-200 bg-gray-50/50 flex gap-4">
            <div class="relative flex-1 max-w-md">
                <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" placeholder="Tìm tên sản phẩm..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 border-b border-gray-200 text-gray-500 font-semibold uppercase text-xs tracking-wider">
                    <tr>
                        <th class="px-6 py-4 w-24">Ảnh</th>
                        <th class="px-6 py-4">Tên sản phẩm</th>
                        <th class="px-6 py-4">Danh mục / Hãng</th>
                        <th class="px-6 py-4 text-center">Tồn kho</th>
                        <th class="px-6 py-4">Giá bán</th>
                        <th class="px-6 py-4 text-right">Hành động</th>
                    </tr>
                </thead>
                <tbody id="product-list" class="divide-y divide-gray-100 bg-white">
                    <tr><td colspan="6" class="py-8 text-center text-gray-500">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="px-6 py-4 border-t border-gray-200 flex justify-between items-center bg-gray-50">
            <button id="btn-prev" class="px-3 py-1.5 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition" disabled>Trước</button>
            <span class="text-xs text-gray-500 font-medium bg-white px-3 py-1.5 rounded-lg border" id="page-info">Trang 1</span>
            <button id="btn-next" class="px-3 py-1.5 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition" disabled>Sau</button>
        </div>
    </div>

    <div id="product-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        
        <div class="absolute right-0 top-0 h-full w-full md:w-[900px] bg-white shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col" id="modal-panel">
            
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800" id="modal-title">Thông tin sản phẩm</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="flex border-b border-gray-200 px-6 bg-white sticky top-0 z-10">
                <button onclick="switchTab('general')" id="tab-btn-general" class="tab-active py-3 px-4 text-sm transition-all hover:bg-gray-50">Thông tin chung</button>
                <button onclick="switchTab('specs')" id="tab-btn-specs" class="tab-inactive py-3 px-4 text-sm transition-all hover:bg-gray-50">Cấu hình chi tiết</button>
                <button onclick="switchTab('variants')" id="tab-btn-variants" class="tab-inactive py-3 px-4 text-sm transition-all hover:bg-gray-50">Biến thể</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 modal-scroll bg-white relative">
                <form id="product-form" class="space-y-6">
                    <input type="hidden" id="p-id">
                    <input type="hidden" id="p-image-url-old">

                    <div id="tab-content-general" class="space-y-5 animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Ảnh đại diện <span class="text-red-500">*</span></label>
                                <div class="flex gap-4 items-start">
                                    <div class="flex-1">
                                        <label id="upload-label" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-blue-50 hover:border-blue-400 transition group">
                                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                                <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 mb-2 group-hover:text-blue-500 transition"></i>
                                                <p class="text-sm text-gray-500 group-hover:text-blue-600 font-medium">Click để tải ảnh lên</p>
                                                <p class="text-xs text-gray-400 mt-1">PNG, JPG, WEBP</p>
                                            </div>
                                            <input id="p-image-file" type="file" class="hidden" accept="image/*" />
                                        </label>
                                    </div>
                                    <div class="w-32 h-32 rounded-xl border border-gray-200 bg-white p-1 flex-shrink-0 flex items-center justify-center relative shadow-sm">
                                        <img id="preview-img" src="https://placehold.co/150?text=No+Img" class="w-full h-full object-contain rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên sản phẩm <span class="text-red-500">*</span></label>
                                <input type="text" id="p-title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium" required>
                            </div>

                            <div class="md:col-span-2 grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Giá bán (VNĐ) <span class="text-red-500">*</span></label>
                                    <input type="number" id="p-price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-blue-600 font-bold" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Giá gốc (VNĐ)</label>
                                    <input type="number" id="p-compare" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tồn kho <span class="text-red-500">*</span></label>
                                    <input type="number" id="p-stock" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="0">
                                </div>
                            </div>

                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 md:col-span-2 grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Loại sản phẩm</label>
                                    <select id="p-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white cursor-pointer hover:bg-gray-50 transition">
                                        <option value="">-- Đang tải --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Hãng sản xuất</label>
                                    <select id="p-brand" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white cursor-pointer" disabled>
                                        <option value="">-- Chọn hãng --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mô tả / Đặc điểm nổi bật</label>
                                <textarea id="p-desc" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm leading-relaxed"></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="tab-content-specs" class="hidden space-y-4 animate-fade-in">
                        <div id="specs-warning" class="p-4 bg-blue-50 text-blue-800 text-sm rounded-lg border border-blue-200 flex items-center gap-3">
                            <i class="fa-solid fa-circle-info text-lg"></i>
                            <span id="specs-status-text">Vui lòng chọn <b>"Loại sản phẩm"</b> để hiển thị bảng thông số.</span>
                        </div>
                        <div id="specs-form-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 hidden"></div>
                    </div>

                    <div id="tab-content-variants" class="hidden space-y-4 animate-fade-in">
                        <div id="variants-add-msg" class="hidden p-6 text-center bg-gray-50 border border-dashed border-gray-300 rounded-xl">
                            <div class="text-gray-400 text-5xl mb-3"><i class="fa-solid fa-layer-group"></i></div>
                            <h4 class="text-gray-800 font-bold">Chưa tạo sản phẩm</h4>
                            <p class="text-sm text-gray-500 mt-2">Vui lòng lưu "Thông tin chung" trước.<br>Sau đó bạn có thể thêm màu sắc và phiên bản.</p>
                        </div>
                        <div id="variants-view-container" class="space-y-6"></div>
                    </div>
                </form>
            </div>

            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center" id="modal-footer">
                <p class="text-xs text-gray-500 italic" id="footer-hint">* Các trường có dấu sao là bắt buộc.</p>
                <div class="flex gap-3">
                    <button id="btn-goto-detail" class="hidden px-4 py-2 text-sm font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg transition items-center gap-2">
                        <i class="fa-solid fa-external-link"></i> Sửa chi tiết
                    </button>
                    <button onclick="closeModal()" class="px-5 py-2 text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm border border-transparent hover:border-gray-300 rounded-lg transition">Đóng</button>
                    <button id="btn-save" onclick="saveProduct()" class="px-6 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition flex items-center gap-2">
                        <i class="fa-solid fa-floppy-disk"></i> Lưu dữ liệu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-root"></div>

    <script type="module">
        import { renderAdminLayout, formatPrice } from '../assets/js/admin.js';
        import { api } from '../assets/js/api.js';
        import { showToast } from '../assets/js/ui/toast.js';

        renderAdminLayout('products');

        let currentSpecsData = {}; 
        let currentVariants = [];

        // ================= XỬ LÝ ẢNH PREVIEW =================
        const fileInput = document.getElementById('p-image-file');
        const previewImg = document.getElementById('preview-img');

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                previewImg.src = URL.createObjectURL(file);
            }
        });

        // ================= LOGIC GIAO DIỆN =================

        window.switchTab = (tabName) => {
            ['general', 'specs', 'variants'].forEach(t => {
                document.getElementById(`tab-content-${t}`).classList.add('hidden');
                document.getElementById(`tab-btn-${t}`).className = 'tab-inactive py-3 px-4 text-sm transition-all hover:bg-gray-50';
            });
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabName}`).className = 'tab-active py-3 px-4 text-sm transition-all hover:bg-gray-50';
        };

        // Khi đổi danh mục
        document.getElementById('p-category').addEventListener('change', function() {
            handleCategoryChange(this.value);
        });

        async function loadCategoriesForSelect() {
            const catSelect = document.getElementById('p-category');
            try {
                const res = await api.getCategories();
                const cats = res.data || [];
                window.allCategories = cats;
                catSelect.innerHTML = '<option value="">-- Chọn loại --</option>';
                cats.forEach(c => catSelect.innerHTML += `<option value="${c.slug}">${c.name}</option>`);
            } catch(e) { console.error(e); }
        }

        async function handleCategoryChange(categorySlug, selectedBrand = '', existingSpecs = null) {
            await updateBrandSelect(categorySlug, selectedBrand);
            const categoryData = window.allCategories?.find(c => c.slug === categorySlug);
            let template = [];
            if (categoryData && categoryData.specs_template) {
                try { 
                    template = typeof categoryData.specs_template === 'string' 
                        ? JSON.parse(categoryData.specs_template) 
                        : categoryData.specs_template; 
                } catch(e){}
            }
            renderSpecsFormFromTemplate(template, existingSpecs || currentSpecsData);
        }

        function renderSpecsFormFromTemplate(template, data) {
            const container = document.getElementById('specs-form-container');
            const warning = document.getElementById('specs-warning');
            container.innerHTML = '';

            if (!template || template.length === 0) {
                container.classList.add('hidden');
                warning.classList.remove('hidden');
                document.getElementById('specs-status-text').textContent = "Danh mục này chưa được cấu hình thông số kỹ thuật.";
                return;
            }

            container.classList.remove('hidden');
            warning.classList.add('hidden');

            template.forEach(group => {
                let fieldsHtml = '';
                group.fields.forEach(f => {
                    const val = data[f.k] || ''; 
                    fieldsHtml += `
                        <div>
                            <label class="block text-[11px] font-bold text-gray-500 mb-1 uppercase tracking-wide">${f.l}</label>
                            <input type="text" name="spec_${f.k}" value="${val}" 
                                class="w-full px-3 py-2 border border-gray-200 rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm bg-gray-50 focus:bg-white transition-colors placeholder-gray-300 shadow-sm"
                                oninput="currentSpecsData['${f.k}'] = this.value"> 
                        </div>`;
                });
                container.innerHTML += `
                    <div class="border border-gray-200 rounded-lg p-4 bg-white shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-gray-100 pb-2">
                            <span class="w-1.5 h-4 bg-blue-600 rounded-full"></span>${group.group}
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">${fieldsHtml}</div>
                    </div>`;
            });
        }

        async function updateBrandSelect(category, selectedBrand = '') {
            const brandSelect = document.getElementById('p-brand');
            brandSelect.innerHTML = '<option value="">Đang tải...</option>';
            brandSelect.disabled = true;
            try {
                const res = await api.getBrands(category);
                const brands = res.data || [];
                brandSelect.innerHTML = '<option value="">-- Chọn hãng --</option>';
                if (brands.length > 0) {
                    brandSelect.disabled = false;
                    brands.forEach(b => {
                        const bName = typeof b === 'object' ? b.name : b;
                        brandSelect.innerHTML += `<option value="${bName}" ${bName === selectedBrand ? 'selected' : ''}>${bName}</option>`;
                    });
                } else {
                    brandSelect.innerHTML = '<option value="">Không có hãng nào</option>';
                }
            } catch (e) { console.error(e); }
        }

        // ================= MODAL & LOGIC =================

        function setFormState(isReadOnly) {
            const form = document.getElementById('product-form');
            const inputs = form.querySelectorAll('input:not([type="hidden"]), textarea, select');
            const btnSave = document.getElementById('btn-save');
            const footerHint = document.getElementById('footer-hint');
            const btnGotoDetail = document.getElementById('btn-goto-detail');
            const uploadLabel = document.getElementById('upload-label');

            inputs.forEach(input => {
                if (isReadOnly) {
                    input.setAttribute('readonly', true);
                    input.classList.add('read-only-input');
                    if(input.tagName === 'SELECT') input.setAttribute('disabled', true);
                } else {
                    input.removeAttribute('readonly');
                    input.classList.remove('read-only-input');
                    if(input.tagName === 'SELECT') input.removeAttribute('disabled');
                }
            });

            // Xử lý riêng cho Brand & Upload khi không readonly
            if (!isReadOnly) {
                const cat = document.getElementById('p-category').value;
                if (!cat) document.getElementById('p-brand').setAttribute('disabled', true);
                
                // Bật click upload ảnh
                uploadLabel.classList.remove('pointer-events-none', 'opacity-50');
            } else {
                // Tắt click upload ảnh
                uploadLabel.classList.add('pointer-events-none', 'opacity-50');
            }

            if (isReadOnly) {
                // VIEW MODE
                btnSave.classList.add('hidden');
                footerHint.classList.add('hidden');
                btnGotoDetail.classList.remove('hidden');
                
                document.getElementById('variants-add-msg').classList.add('hidden');
                document.getElementById('variants-view-container').classList.remove('hidden');
            } else {
                // ADD/EDIT MODE
                btnSave.classList.remove('hidden');
                footerHint.classList.remove('hidden');
                btnGotoDetail.classList.add('hidden');

                document.getElementById('variants-add-msg').classList.remove('hidden');
                document.getElementById('variants-view-container').classList.add('hidden');
            }
        }

        window.openModal = async (mode, data = null) => {
            const modal = document.getElementById('product-modal');
            const panel = document.getElementById('modal-panel');
            const title = document.getElementById('modal-title');
            const tabVariants = document.getElementById('tab-btn-variants');

            modal.classList.remove('hidden');
            setTimeout(() => panel.classList.remove('translate-x-full'), 10);
            
            // Reset Form
            document.getElementById('product-form').reset();
            document.getElementById('preview-img').src = 'https://placehold.co/150?text=No+Img';
            document.getElementById('p-image-url-old').value = '';
            switchTab('general');
            currentSpecsData = {}; 

            if (mode === 'add') {
                title.innerText = 'Thêm sản phẩm mới';
                setFormState(false);
                document.getElementById('p-id').value = '';
                document.getElementById('p-stock').value = '0';
                
                document.getElementById('specs-form-container').classList.add('hidden');
                document.getElementById('specs-warning').classList.remove('hidden');
                tabVariants.classList.add('hidden'); // Ẩn tab variant khi thêm mới
            } 
            else {
                title.innerText = 'Chi tiết sản phẩm (Chỉ xem)';
                tabVariants.classList.remove('hidden');
                document.getElementById('btn-goto-detail').onclick = () => window.location.href = `product-detail.html?id=${data.id}`;

                // Fill Data
                document.getElementById('p-id').value = data.id;
                document.getElementById('p-title').value = data.title;
                document.getElementById('p-price').value = data.price;
                document.getElementById('p-stock').value = data.stock_quantity || 0;
                document.getElementById('p-compare').value = data.compare_at || '';
                document.getElementById('p-desc').value = data.description || '';
                document.getElementById('p-category').value = data.category || '';

                // Xử lý ảnh
                const imgUrl = data.image ? (data.image.startsWith('http') ? data.image : `../${data.image}`) : 'https://placehold.co/150?text=No+Img';
                document.getElementById('preview-img').src = imgUrl;
                document.getElementById('p-image-url-old').value = data.image || '';

                // Specs & Brands
                let specsData = {};
                try { specsData = typeof data.specs === 'string' ? JSON.parse(data.specs) : (data.specs || {}); } catch(e){}
                currentSpecsData = specsData;
                await handleCategoryChange(data.category, data.brand, specsData);

                // Load Variants ReadOnly
                loadVariantsReadOnly(data.id);
                setFormState(true);
            }
        };

        window.closeModal = () => {
            document.getElementById('modal-panel').classList.add('translate-x-full');
            setTimeout(() => document.getElementById('product-modal').classList.add('hidden'), 300);
        };

        // ================= SAVE LOGIC (QUAN TRỌNG) =================

        window.saveProduct = async () => {
            const id = document.getElementById('p-id').value;
            
            // Gom Specs
            const specInputs = document.querySelectorAll('input[name^="spec_"]');
            specInputs.forEach(input => {
                currentSpecsData[input.name.replace('spec_', '')] = input.value.trim();
            });

            // Gom Data Cơ Bản
            const data = {
                title: document.getElementById('p-title').value,
                price: document.getElementById('p-price').value,
                stock_quantity: document.getElementById('p-stock').value,
                compare_at: document.getElementById('p-compare').value,
                category: document.getElementById('p-category').value,
                brand: document.getElementById('p-brand').value,
                description: document.getElementById('p-desc').value,
                specs: currentSpecsData,
                // Mặc định lấy ảnh cũ, nếu tạo mới thì là rỗng (sẽ update sau)
                image: document.getElementById('p-image-url-old').value 
            };

            if (!data.title || !data.price) return alert('Vui lòng nhập Tên và Giá sản phẩm');

            try {
                let productId = id;
                let isNew = false;

                // 1. TẠO HOẶC UPDATE THÔNG TIN CƠ BẢN TRƯỚC
                if (id) {
                    await api.updateProduct(id, data);
                    showToast('Đã cập nhật thông tin', 'success');
                } else {
                    const res = await api.createProduct(data);
                    productId = res.id;
                    isNew = true;
                }

                // 2. NẾU CÓ FILE ẢNH ĐƯỢC CHỌN -> UPLOAD VÀ CẬP NHẬT
                const file = document.getElementById('p-image-file').files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('image', file);
                    // Upload image cho sản phẩm (không có variant_id)
                    await api.uploadProductImage(productId, formData);
                    if(isNew) showToast('Đã tải ảnh lên thành công', 'success');
                }

                // 3. XỬ LÝ SAU KHI LƯU
                if (isNew) {
                    if (confirm('Sản phẩm đã tạo. Bạn có muốn chuyển sang trang chi tiết để thêm Biến thể (Màu sắc/Cấu hình) không?')) {
                        window.location.href = `product-detail.html?id=${productId}`;
                    } else {
                        window.closeModal();
                        loadProducts(currentPage);
                    }
                } else {
                    // Update mode -> Đóng modal
                    window.closeModal();
                    loadProducts(currentPage);
                }

            } catch(e) {
                showToast(e.message || 'Có lỗi xảy ra', 'error');
                console.error(e);
            }
        };

        // ================= CÁC HÀM PHỤ TRỢ KHÁC (VIEW, DELETE, LOAD) =================

        async function loadVariantsReadOnly(productId) {
            const container = document.getElementById('variants-view-container');
            container.innerHTML = '<p class="text-center text-gray-500">Đang tải biến thể...</p>';
            try {
                const res = await api.request(`/products/${productId}/variants`);
                const variants = res.data || [];
                if (variants.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-400 italic">Chưa có biến thể.</p>';
                    return;
                }

                // Group by color
                const groups = {};
                variants.forEach(v => {
                    const c = (v.attributes?.color || v.color || 'Mặc định').trim();
                    if (!groups[c]) groups[c] = [];
                    groups[c].push(v);
                });

                let html = '';
                Object.entries(groups).forEach(([color, vars]) => {
                    // Collect images
                    let imgs = [];
                    vars.forEach(v => {
                        if(v.gallery && v.gallery.length) v.gallery.forEach(i => !imgs.includes(i) && imgs.push(i));
                        else if(v.image && !imgs.includes(v.image)) imgs.push(v.image);
                    });

                    // Render Rows
                    const rows = vars.map(v => {
                        const attrs = v.attributes || {};
                        const info = Object.keys(attrs).filter(k => k!=='color').map(k => `<span class="bg-gray-100 px-2 py-0.5 rounded text-xs mr-1">${attrs[k]}</span>`).join('');
                        return `<tr class="border-b last:border-0 border-gray-100"><td class="p-2 text-sm">${info||'--'}</td><td class="p-2 text-sm font-bold text-right">${formatPrice(v.price)}</td><td class="p-2 text-sm text-center">${v.stock_quantity}</td></tr>`;
                    }).join('');

                    html += `
                        <div class="border rounded-lg bg-white mb-4 overflow-hidden">
                            <div class="bg-gray-50 px-4 py-2 border-b flex items-center gap-2 font-bold text-gray-700 text-sm uppercase">
                                <span class="w-3 h-3 rounded-full bg-blue-500"></span> Màu: ${color}
                            </div>
                            <div class="grid grid-cols-4 divide-x">
                                <div class="p-3 bg-white grid grid-cols-2 gap-2 content-start">
                                    ${imgs.length ? imgs.map(i => `<img src="../${i}" class="aspect-square object-cover rounded border">`).join('') : '<span class="text-xs text-gray-400 col-span-2 text-center">No Img</span>'}
                                </div>
                                <div class="col-span-3">
                                    <table class="w-full text-left"><thead class="bg-gray-50 text-[10px] uppercase text-gray-500"><tr><th class="p-2">Thuộc tính</th><th class="p-2 text-right">Giá</th><th class="p-2 text-center">Kho</th></tr></thead><tbody>${rows}</tbody></table>
                                </div>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
            } catch(e) { container.innerHTML = '<p class="text-red-500 text-center">Lỗi tải</p>'; }
        }

        window.viewProduct = async (id) => {
            try { window.openModal('view', await api.getProduct(id)); } catch(e) { console.error(e); }
        };

        window.deleteProduct = async (id) => {
            if(!confirm('Xóa sản phẩm này?')) return;
            try { await api.deleteProduct(id); showToast('Đã xóa', 'success'); loadProducts(currentPage); } 
            catch(e) { showToast('Lỗi xóa', 'error'); }
        };

        let currentPage = 1;
        async function loadProducts(page = 1) {
            currentPage = page;
            try {
                const res = await api.getProducts({ page: 1 });
                const html = (res.data || []).map(p => `
                    <tr class="hover:bg-blue-50/50 transition border-b border-gray-100 last:border-0 group">
                        <td class="px-6 py-4 w-24">
                            <div class="w-16 h-16 rounded-lg border bg-white p-1 overflow-hidden">
                                <img src="../${p.image}" class="w-full h-full object-contain group-hover:scale-110 transition" onerror="this.src='https://placehold.co/64?text=No+Img'">
                            </div>
                        </td>
                        <td class="px-6 py-4"><p class="font-semibold text-gray-800 line-clamp-2">${p.title}</p><span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">#${p.id}</span></td>
                        <td class="px-6 py-4"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded block w-fit mb-1">${p.category||'--'}</span><span class="text-xs text-gray-500">${p.brand||'--'}</span></td>
                        <td class="px-6 py-4 text-center">${p.stock_quantity > 0 ? `<span class="font-bold text-gray-700">${p.stock_quantity}</span>` : `<span class="text-red-500 font-bold text-xs bg-red-50 px-2 py-1 rounded border border-red-100">Hết hàng</span>`}</td>
                        <td class="px-6 py-4"><span class="font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded border border-emerald-100">${formatPrice(p.price)}</span></td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2 opacity-80 group-hover:opacity-100">
                                <button onclick="window.viewProduct(${p.id})" class="w-9 h-9 rounded bg-white border hover:border-blue-300 hover:text-blue-600 transition flex items-center justify-center"><i class="fa-solid fa-eye"></i></button>
                                <button onclick="window.location.href='product-detail.html?id=${p.id}'" class="w-9 h-9 rounded bg-white border hover:bg-blue-50 hover:text-blue-600 transition flex items-center justify-center"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button onclick="window.deleteProduct(${p.id})" class="w-9 h-9 rounded bg-white border hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('product-list').innerHTML = html;
            } catch (e) { document.getElementById('product-list').innerHTML = `<tr><td colspan="6" class="text-center py-8 text-red-500">Lỗi tải dữ liệu!</td></tr>`; }
        }

        loadCategoriesForSelect(); 
        document.getElementById('btn-add').addEventListener('click', () => window.openModal('add'));
        loadProducts();
    </script>
</body>
</html>